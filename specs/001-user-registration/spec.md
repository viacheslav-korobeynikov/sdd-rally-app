# Feature Specification: Регистрация и аутентификация пользователей

**Feature Branch**: `1-user-registration`  
**Created**: 2025-12-17  
**Status**: Draft  
**Input**: User description: "Я как пользователь хочу зарегистрироваться в приложении, чтобы создать соревнование. При регистрации я хочу указать логин и пароль, чтобы иметь возможность в дальнейшем авторизовываться через них"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Регистрация нового пользователя (Priority: P1)

Организатор ралли впервые заходит в приложение и хочет создать свой аккаунт, чтобы начать работу с системой. Он заполняет форму регистрации с логином и паролем, после успешной регистрации получает доступ к системе и может создавать соревнования.

**Why this priority**: Это базовая функция, без которой невозможна работа с системой. Регистрация является входной точкой для всех пользователей - это абсолютный MVP.

**Independent Test**: Можно полностью протестировать, открыв страницу регистрации, заполнив форму с валидными данными и проверив, что аккаунт создан и пользователь может войти в систему.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице регистрации, **When** он вводит уникальный логин (минимум 3 символа), надёжный пароль (минимум 12 символов с заглавными буквами, строчными и цифрами) и подтверждение пароля, **Then** система создаёт аккаунт, автоматически авторизует пользователя и перенаправляет на главную страницу с сообщением об успешной регистрации

2. **Given** пользователь находится на странице регистрации, **When** он вводит логин, который уже существует в системе, **Then** система показывает сообщение "Пользователь с таким логином уже существует" и не создаёт аккаунт

3. **Given** пользователь находится на странице регистрации, **When** он вводит пароль короче 12 символов или без требуемой сложности, **Then** система показывает сообщение с требованиями к паролю и не позволяет отправить форму

4. **Given** пользователь находится на странице регистрации, **When** он вводит пароль и подтверждение пароля, которые не совпадают, **Then** система показывает сообщение "Пароли не совпадают" и не позволяет отправить форму

---

### User Story 2 - Вход в систему (Priority: P1)

Зарегистрированный пользователь возвращается в приложение и хочет войти в свой аккаунт, используя ранее созданные логин и пароль.

**Why this priority**: Без аутентификации пользователь не может получить доступ к своим соревнованиям и данным. Это критическая функция, неразрывно связанная с регистрацией.

**Independent Test**: Можно протестировать, создав тестового пользователя, выйдя из системы, затем войдя с его учётными данными и проверив доступ к системе.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице входа и имеет зарегистрированный аккаунт, **When** он вводит правильные логин и пароль, **Then** система авторизует пользователя, создаёт сессию и перенаправляет на главную страницу

2. **Given** пользователь находится на странице входа, **When** он вводит несуществующий логин или неправильный пароль, **Then** система показывает сообщение "Неверный логин или пароль" без указания, что именно неверно (для безопасности)

3. **Given** пользователь уже авторизован в системе, **When** он пытается открыть страницу входа напрямую, **Then** система перенаправляет его на главную страницу

4. **Given** пользователь делает 5 неудачных попыток входа подряд с одного IP-адреса, **When** он пытается войти в 6-й раз, **Then** система показывает captcha для подтверждения, что это не бот

---

### User Story 3 - Выход из системы (Priority: P2)

Пользователь хочет завершить свою рабочую сессию и безопасно выйти из приложения, особенно если работает на общем компьютере.

**Why this priority**: Функция важна для безопасности, но система может работать и без неё на начальном этапе (пользователь может просто закрыть браузер).

**Independent Test**: Авторизованный пользователь нажимает кнопку "Выход" и проверяет, что сессия завершена, доступ к защищённым страницам закрыт, и при возврате требуется повторный вход.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован в системе, **When** он нажимает кнопку "Выход", **Then** система удаляет сессию, очищает cookie авторизации и перенаправляет на страницу входа

2. **Given** пользователь вышел из системы, **When** он пытается открыть защищённую страницу (например, список соревнований), **Then** система перенаправляет его на страницу входа с сообщением "Требуется авторизация"

---

### User Story 4 - Назначение роли пользователю (Priority: P3)

Главный организатор хочет назначить роли другим пользователям системы (секретарь, хронометраж, наблюдатель), чтобы распределить обязанности в команде.

**Why this priority**: Функция необходима для полноценной работы команды организаторов, но на MVP этапе один пользователь может выполнять все роли самостоятельно.

**Independent Test**: Главный организатор создаёт несколько пользователей, назначает им разные роли, затем проверяет, что каждый пользователь видит только те функции, которые доступны его роли.

**Acceptance Scenarios**:

1. **Given** пользователь с ролью "Главный организатор" просматривает список пользователей, **When** он выбирает пользователя и назначает ему роль "Секретарь", **Then** система сохраняет новую роль и выбранный пользователь получает соответствующие права доступа

2. **Given** пользователь без роли "Главный организатор" пытается открыть страницу управления пользователями, **When** он обращается к этой странице, **Then** система показывает сообщение "Недостаточно прав доступа" и не отображает функционал

---

### Edge Cases

- **Что происходит, когда пользователь вводит логин с пробелами в начале/конце?** Система автоматически удаляет пробелы (trim) перед сохранением

- **Что происходит, когда пользователь вводит логин в разном регистре (User vs user)?** Логины не чувствительны к регистру - система преобразует их в нижний регистр при сохранении и проверке

- **Что происходит, когда пользователь пытается использовать специальные символы в логине?** Логин может содержать только латинские буквы, цифры, дефис и подчеркивание. Другие символы запрещены

- **Что происходит при потере соединения во время регистрации?** Если запрос не дошёл до сервера, пользователь видит сообщение об ошибке сети и может повторить попытку. Если запрос обработан, но ответ потерян, при повторной попытке система вернёт ошибку "Пользователь уже существует"

- **Что происходит с неактивными сессиями?** Сессия автоматически завершается через 1 час с момента последней активности. При следующем запросе пользователь перенаправляется на страницу входа

- **Какой уровень сложности имеет captcha?** Captcha представляет собой простую математическую задачу (сложение или вычитание двух чисел в диапазоне 1-20), решаемую средним пользователем менее чем за 30 секунд. Не требует регистрации у внешних провайдеров captcha

- **Что происходит, когда пользователь пытается войти с разных устройств одновременно?** Система разрешает множественные активные сессии для одного пользователя (пользователь может работать с компьютера и планшета одновременно)

- **Что происходит после 10 неудачных попыток входа?** После 10 неудачных попыток в течение 15 минут, аккаунт блокируется на 30 минут

## Requirements *(mandatory)*

### Functional Requirements

#### Регистрация

- **FR-001**: Система ДОЛЖНА предоставлять форму регистрации, доступную неавторизованным пользователям
- **FR-002**: Система ДОЛЖНА требовать следующие поля при регистрации: логин (обязательно), пароль (обязательно), подтверждение пароля (обязательно)
- **FR-003**: Система ДОЛЖНА валидировать логин: минимум 3 символа, максимум 50 символов, только латинские буквы, цифры, дефис и подчеркивание
- **FR-004**: Система ДОЛЖНА проверять уникальность логина (без учёта регистра) перед созданием аккаунта
- **FR-005**: Система ДОЛЖНА валидировать пароль: минимум 12 символов, минимум 1 заглавная буква, минимум 1 строчная буква, минимум 1 цифра
- **FR-006**: Система ДОЛЖНА проверять совпадение пароля и подтверждения пароля
- **FR-007**: Система ДОЛЖНА хешировать пароль перед сохранением в базу данных (bcrypt или argon2)
- **FR-008**: Система ДОЛЖНА автоматически авторизовывать пользователя после успешной регистрации
- **FR-009**: Система ДОЛЖНА назначать роль "Главный организатор" первому зарегистрированному пользователю, и роль "Наблюдатель" всем последующим (до явного изменения роли)
- **FR-010**: Система ДОЛЖНА логировать все попытки регистрации (успешные и неуспешные) с указанием IP-адреса и временной метки

#### Аутентификация

- **FR-011**: Система ДОЛЖНА предоставлять форму входа с полями: логин, пароль
- **FR-012**: Система ДОЛЖНА проверять логин без учёта регистра
- **FR-013**: Система ДОЛЖНА сравнивать введённый пароль с хешированным значением в базе данных
- **FR-014**: Система ДОЛЖНА создавать безопасную сессию (HTTP-only, Secure cookie) при успешной аутентификации
- **FR-015**: Система ДОЛЖНА устанавливать время жизни сессии в 1 час
- **FR-016**: Система ДОЛЖНА отслеживать неудачные попытки входа по IP-адресу и логину
- **FR-017**: Система ДОЛЖНА показывать captcha после 5 неудачных попыток входа с одного IP за 15 минут
- **FR-018**: Система ДОЛЖНА блокировать попытки входа на 30 минут после 10 неудачных попыток за 15 минут
- **FR-019**: Система ДОЛЖНА логировать все попытки входа (успешные и неуспешные) с указанием логина, IP-адреса, user agent и временной метки
- **FR-020**: Система ДОЛЖНА перенаправлять авторизованных пользователей с страниц входа/регистрации на главную страницу

#### Авторизация

- **FR-021**: Система ДОЛЖНА проверять наличие активной сессии для всех защищённых страниц
- **FR-022**: Система ДОЛЖНА перенаправлять неавторизованных пользователей на страницу входа при попытке доступа к защищённым ресурсам
- **FR-023**: Система ДОЛЖНА завершать сессию автоматически через 1 час с момента последней активности
- **FR-024**: Система ДОЛЖНА предоставлять функцию выхода, которая удаляет сессию и очищает cookies
- **FR-025**: Система ДОЛЖНА сохранять информацию о роли пользователя в сессии для проверки прав доступа

#### Управление ролями

- **FR-026**: Система ДОЛЖНА предоставлять 4 роли: Главный организатор, Секретарь, Хронометраж, Наблюдатель
- **FR-027**: Система ДОЛЖНА разрешать изменение ролей только пользователям с ролью "Главный организатор"
- **FR-028**: Система ДОЛЖНА логировать все изменения ролей с указанием: кто изменил, чью роль, старое значение, новое значение, временная метка

### Key Entities

- **User (Пользователь)**: Представляет зарегистрированного пользователя системы. Атрибуты: уникальный идентификатор (UUID), логин (уникальный, нечувствительный к регистру), хешированный пароль, роль (одна из 4 доступных), дата создания, дата последнего входа, статус (активен/заблокирован)

- **Session (Сессия)**: Представляет активную сессию пользователя. Атрибуты: уникальный идентификатор сессии, ссылка на пользователя, время создания, время последней активности, IP-адрес, user agent

- **LoginAttempt (Попытка входа)**: Представляет попытку аутентификации для анализа безопасности. Атрибуты: временная метка, логин (попытка), IP-адрес, user agent, результат (успех/неудача), причина неудачи (если применимо)

- **RoleChange (Изменение роли)**: Представляет аудит-запись изменения роли пользователя. Атрибуты: временная метка, пользователь (кого изменили), администратор (кто изменил), старая роль, новая роль, причина (опционально)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователи могут завершить регистрацию за время менее 2 минут от момента открытия страницы `/register` до перенаправления на главную страницу (включая загрузку формы, заполнение и обработку на сервере)

- **SC-002**: Система обрабатывает 100 одновременных запросов на регистрацию без задержек более 3 секунд на запрос

- **SC-003**: 95% пользователей успешно проходят регистрацию с первой попытки (без ошибок валидации, вызванных недостаточно чёткими требованиями) в течение первого месяца после запуска системы в production

- **SC-004**: Все попытки входа с неправильным паролем блокируются, и система показывает одинаковое сообщение для несуществующего логина и неправильного пароля (защита от перечисления пользователей)

- **SC-005**: Система автоматически блокирует брутфорс атаки - после 5 неудачных попыток появляется captcha, после 10 - блокировка на 30 минут

- **SC-006**: Время входа в систему (от ввода данных до загрузки главной страницы) составляет менее 2 секунд в 99% случаев

- **SC-007**: Все события безопасности (регистрация, вход, неудачные попытки, изменения ролей) логируются с полной информацией для аудита

- **SC-008**: Система корректно обрабатывает потерю соединения - пользователь получает понятное сообщение об ошибке и может повторить действие

## Assumptions

1. **Язык интерфейса**: Интерфейс регистрации и аутентификации на русском языке (в соответствии с конституцией проекта)

2. **Email не требуется**: На начальном этапе email не запрашивается при регистрации (может быть добавлен в будущем для восстановления пароля)

3. **Восстановление пароля**: Функция восстановления забытого пароля не входит в текущий scope (будет отдельная feature в будущем)

4. **Хранение паролей**: Используется bcrypt с cost factor 12 (в соответствии со стандартами безопасности проекта)

5. **Первый пользователь = администратор**: Первый зарегистрированный пользователь автоматически получает роль "Главный организатор" и полные права

6. **HTTPS**: В production окружении предполагается использование HTTPS для защиты передачи учётных данных

7. **CSRF защита**: Все формы регистрации и входа защищены CSRF токенами (в соответствии с конституцией)

8. **Регистр логинов**: Логины хранятся и проверяются без учёта регистра (user, User, USER - это один пользователь)

9. **Множественные сессии**: Пользователь может иметь несколько активных сессий с разных устройств одновременно

10. **Captcha провайдер**: Для защиты от ботов используется решение, не требующее внешних зависимостей на MVP этапе (простая математическая captcha или аналог)

## Out of Scope

Следующие элементы явно **НЕ включены** в данную feature и будут рассмотрены отдельно:

- ❌ Восстановление забытого пароля
- ❌ Изменение пароля пользователем
- ❌ Двухфакторная аутентификация (2FA)
- ❌ OAuth/Social login (вход через Google, Facebook и т.д.)
- ❌ Регистрация по email с подтверждением
- ❌ Профиль пользователя (имя, фото, контактные данные)
- ❌ История входов в систему (audit log для пользователя)
- ❌ Управление множественными сессиями (просмотр активных сессий, завершение других сессий)
- ❌ Блокировка/разблокировка пользователей администратором
- ❌ Удаление аккаунта пользователем

